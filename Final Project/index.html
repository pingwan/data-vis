<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Data Visualisation Final Project</title>

    <link rel="stylesheet" href="/libraries/bootstrap/css/bootstrap.min.css"> 
    <link rel="stylesheet" href="/libraries/bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" type="text/css" href="/libraries/d3.slider.css" media="screen" />
    <script src="/libraries/d3.min.js" charset="utf-8"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/1.7.0/d3-legend.js" charset="utf-8"></script>


    <script src="/libraries/jquery.min.js" charset="utf-8"></script>
    <script src="/libraries/d3.slider.js" charset="utf-8"></script>
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

    <style>
        .container{
            width: 1100px !important;
        }

        #countries_container{
            height:1000px;
            overflow: scroll;
        }

        #graph_container{
            width: 697px; 
            height: 450px;
            padding: 0;
            position: relative; 
        }

        .trendline {
          fill: none;
          stroke-width: 1.5px;
        }

        .axis path {
            fill: none;
            stroke: #777;
            shape-rendering: crispEdges;
        }

        div.tooltip {   
          position: absolute;           
          text-align: center;                           
          padding: 10px;             
          font: 12px sans-serif;        
          background: black;  
          border: 0px;             
          pointer-events: none;  
          color:white;       
}
    </style>

<body>

    <div class="container">

        <div class="row" style="margin-bottom:px;">
            <div class="col-xs-12" >
                <div id="year" style=" text-align: center;:center;">
                </div>
            </div>
        </div>

        <div class="row" style="margin-bottom:45px;">
            <div class="col-xs-12">
                <div id="slider_container"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-9">
                <div class="row">
                    <div class="col-xs-12">
                       
                            <span>
                                <label>Dataset 1</label>
                                <select>
                                    <option value="emission">Emission</option>
                                    <option value="population">Population</option>
                                </select>
                            </span>
                            <span class="pull-right">
                                <label>Dataset 2</label>
                                <select>
                                    <option value="emission">Emission</option>
                                    <option value="population">Population</option>
                                </select>
                            </span>
                       
                    </div>
                    <div class="col-xs-12">
                        <div id="map_container"></div>
                    </div>
                    <div class="col-xs-12">
                        <div id="color_legend"></div>
                    </div>
                    <div class="col-xs-12">
                        <div id="graph_container"></div>
                    </div>
                </div>
            </div>
            <div class="col-xs-3">
                <div id="countries_container"></div>
            </div>

        </div>

    
    </div>

<script>
    
    var available_countries;
    var emission_data;
    var current_year = 1960;
    var width = 800,
        height = 450;
    var svg;
    var map;
    var projection;
    var interval;
    var header;
    var colorScale;
    var margin = {
        top: 40, 
        right: 50, 
        bottom: 50, 
        left: 50};

    var chartWidth = width - margin.left - margin.right;
    var chartHeight = height - margin.top - margin.bottom; 

    var x = d3.scale.linear().range([0, chartWidth]);
    var y = d3.scale.linear().range([chartHeight, 0]);

    var div = d3.select("body").append("div")   
                .attr("class", "tooltip")               
                .style("opacity", 0);

    var slider = d3.slider().min(1960).max(2011).value(1960).step(1).axis(d3.svg.axis().orient("bottom").tickFormat(d3.format("d")));

    slider.on("slide", function(){
        current_year = slider.value();
        //d3.select("#year").html("<h2>" + current_year +"</h2>");
        updateMap();
        createLegend();
    });

    var slider_actual = d3.select("#slider_container").call(slider);
        
    var graph = d3.select("#graph_container")
        .append("svg")
        .attr("height",height + margin.top + margin.bottom)
        .attr("width",width + margin.left + margin.right)
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


    var xAxis_group = graph.append("g")
                .attr("class","axis")
                .attr("transform", "translate(0," + chartHeight + ")")

    var yAxis_group = graph.append("g")
                .attr("class","axis")

    // xAxis label
    graph.append("text") 
        .attr("transform", "translate(" + ((width / 2)-margin.left) + " ," + (height - margin.bottom) +")")
        .style("text-anchor", "middle")
        .text("Year");

    //yAxis label
    graph.append("text")
            .attr("transform", "rotate(-90)")
            .attr("y", 0 - margin.left)
            .attr("x", 0 - ((height / 2) - margin.top))
            .attr("dy", "1em")
            .style("text-anchor", "middle")
            .text("Emissions");

    

    function drawMap(data){
                
        //draw the svg for map
        svg = d3.select("#map_container")
                    .append("svg")
                    //.style("background-color","blue")
                    .attr("width",width)
                    .attr("height",height)
                    .append("g")
                    .classed("map",true)
                    .style("background","blue");

        //initiate projection
        projection  = d3.geo.mercator()
                            .scale(100)
                            .translate([width/2,height/1.4]);
        
        var path = d3.geo.path().projection(projection);
        
        //create the map
        map = svg.selectAll("path")
                    .data(data.features)
                    .enter()
                    .append("path")
                    .attr("d",path)
                    //.style("fill",'rgb(9,157,217)')
                    .style("stroke",'black')
                    .style("stroke-width",0.5);
        
        
        d3.csv("emission_data.csv",function(d){
          
            //console.log(d);
            
            
            emission_data = d;
            
            emission_data =  emission_data.filter(function(d){
                return (available_countries.indexOf(d['Country Code']) !== -1);
            })
            
            /*interval = setInterval(function(){
                if(current_year < 1965){
                    updateMap();
                    current_year++;
                    //console.log("sdf");
                }
            },200)*/

            updateMap();
            createLegend();
            
            
        })


    }
    
    function updateMap(){
        
        

        d3.select("#year").html("<h2>" + current_year +"</h2>")
        
        var nested = d3.nest()
                        .key(function(d){
                            return d['Country Code']
                        })
                        
                        .rollup(function(leaves){
                            //console.log(emission_data.indexOf(leaves[0]))


                            if(leaves[0][current_year] === ""){
                                return 0;    
                            }else{
                                return{
                                    "Country Name": leaves[0]["Country Name"],
                                    "Emission": parseInt(leaves[0][[current_year]]),
                                    "Index": emission_data.indexOf(leaves[0])
                                }

                            }
                            
                        })
                        .map(emission_data);

         
         createTable();
        
        colorScale = d3.scale.linear()
                        .range(['#fffc57', '#e80000'])
                        .domain(d3.extent(d3.values(nested).map(function(d){return d["Emission"]})));

        svg.selectAll("path")
                    .style("fill",function(d){
                        if(nested[d.id]){

                            return colorScale(nested[d.id]["Emission"]);
                        }else{
                           
                            return "black";
                        }
                    }).on("mouseover",function(d,i){
   
                        div.transition()        
                            .duration(200)      
                            .style("opacity", .9);      
            
                        div.html(function(){
                            return nested[d.id]["Country Name"] + " - " + nested[d.id]["Emission"];
                        })
                        .style("left", (d3.event.pageX) + "px")     
                        .style("top", (d3.event.pageY - 28) + "px");

                        //console.log(nested[d.id]["Index"]);
                        var data = [];
                        for (var i = 1960; i < 2012; i++) {
                            var entry = {};
                            entry.date = i;
                            entry.emission = parseFloat(emission_data[nested[d.id]["Index"]][i]);
                            data.push(entry);
                        };
                        console.log(data);
                        //console.log(emission_data);
                        //GRAPH STUFF HERE?
                        x.domain([1960,2011]);
                        y.domain([0, d3.max(data,function(d){
                            return d.emission;    
                        })]);
                        

                        var xAxis = d3.svg.axis()
                            .scale(x)
                            .orient("bottom");

                        var yAxis = d3.svg.axis()
                            .scale(y)
                            .orient("left");

                        var line = d3.svg.line()
                            .x(function(d){
                                return x(d.date);
                            })
                            .y(function(d){
                                return y(d.emission);
                            })

                        var trendLine = graph.selectAll(".trendline").data([data]);

                        //enter
                        trendLine.enter().append("path").classed("trendline",true);

                        //update
                        trendLine.transition().duration(1000).ease("linear")
                        .attr("d",function(d){
                            return line(d);
                        }).style("stroke",function(d){
                            return "red";
                        });
                        
                        //exit
                        trendLine.exit().remove();

                        //update axis
                        xAxis_group.transition().call(xAxis);
                        yAxis_group.transition().call(yAxis);
            
                    }).on("mouseout",function(d,i){
                           
                        div.transition()        
                            .duration(500)      
                            .style("opacity", 0);   
        
                    })
                
    }
        
//        /*function plot_points(data){
//            //draw circle logic
//            
//            var nested = d3.nest()
//                            .key(function(d){
//                                return d['date'].getUTCFullYear();
//                            })
//                            .rollup(function(leaves){
//                                var total = d3.sum(leaves,function(d){
//                                    return d['attendace'];
//                                })   
//                                
//                                var coords = leaves.map(function(d){
//                                    return projection([+d.long,+d.lat]);
//                                })
//                                
//                                var center_x = d3.mean(coords,function(d){
//                                    return d[0];
//                                });
//                                
//                                var center_y = d3.mean(coords,function(d){
//                                    return d[1];
//                                })
//                                
//                                var teams = d3.set();
//                                
//                                leaves.forEach(function(d){
//                                    teams.add(d['team1']);
//                                    teams.add(d['team2']);
//                                })
//                                
//                                //console.log(teams);
//                                
//                                return {
//                                    'attendance' : total,
//                                    'x' : center_x,
//                                    'y' : center_y,
//                                    'teams' : teams.values()
//                                };
//                            })
//                            .entries(data);
//            
//            //console.log(nested);
//            var temp = nested[0];
//            nested = [];
//            nested.push(temp);
//            
//            //console.log(nested);
//            
//            var teams = temp.values.teams;
//            //console.log(teams);
//            
//            //console.log(nested);
//            
//                /*var attendance_extend = d3.extent(nested,function(d){
//                    return d.values['attendance'];
//                })*
//                
//                /*var radius = d3.scale.sqrt()
//                                .domain(attendance_extend)
//                                .range([0,12]);*/
//            
//                /*svg.append("g")
//                    .classed("bubble",true)
//                    .selectAll("circle")
//                    /*.data(nested.sort(function(a,b){
//                        return b.values['attendance'] -  a.values['attendance'];
//                    }),function(d){
//                        return d['key'];
//                    })*/
//                    .data(nested)
//                    .enter()
//                    .append("circle")
//                    .attr("cx",function(d){
//                        console.log(d);
//                        return d.values.x;
//                    })
//                    .attr("cy",function(d){
//                        return d.values.y
//                    })
//                    .attr("r",function(d){
//                        return 10;
//                    })
//                    .attr("fill","rgb(247,148,32)")
//                    .attr("stroke",'black')
//                    .attr("stroke-width",0.7)
//                    .attr("opacity",0.7);
//            
//                console.log(teams);
//                svg.selectAll("path")
//                    .style("fill",function(d){
//                        //console.log(d);
//                        if(teams.indexOf(d.properties.name) !== -1){
//                            //console.log("hoi");
//                            return "red";
//                        }else{
//                            //console.log("hoi2");
//                            return "white";    
//                        }
//                        
//                    });
//                
//            
//        };
//        
//        function update(year){
//            
//            var filtered = nested.filter(function(d){
//                return new Date(d['key']).getUTCYear() == year;
//            });
//            
//            //var circle = 
//            
//            
//            
//        }
        
        /*var format = d3.time.format("%d-%m-%Y (%H:%M h)");
        
        d3.tsv("world_cup_geo.tsv",function(d){
            d['attendace'] = +d['attendance'];
            d['date'] = format.parse(d['date']);
            return d;
        }, plot_points);*/
        
        
    
    
    
    d3.json("world_countries.json",function(d){
        
        available_countries = d.features.map(function(d){
            return d.id;
        });
        
        //console.log(available_countries.slice(0,100));
        //console.log(available_countries.slice(100,200));
        
        drawMap(d);

    })


    function highlightCountry(obj){
      
        svg.selectAll("path")
                    .style("fill",function(d){
                    
                        if(d.id != obj.key){
                            return "black"
                        }else{
                            return colorScale(obj.values["Emission"]);
                        }
                    });
        

    }

  

    function createTable(){

        $("#countries_container").empty();

        var nested = d3.nest()
                        .key(function(d){
                            return d['Country Code']
                        })
                        .rollup(function(leaves){
                        
                            return {
                                "Country" : leaves[0]["Country Name"],
                                "Emission" : leaves[0][current_year]
                            }

                        })
                        .entries(emission_data);

        

        var table = d3.select('#countries_container')
                        .append('table')
                        .classed("table",true)
                        .classed("table-striped",true)
                        .classed("table-bordered",true)
                        .style("width","100%");
        

        var heading = ["Country","Emission"];

        table.append('thead')
            .append("tr")
            .selectAll("th")
            .data(heading) 
            .enter()
                .append("th")
                .text(function(d,i){
                    return d;
                })


        var tr = table.append('tbody')
                    .selectAll('tr')
                    .data(nested)
                    .enter()
                    .append('tr')
                    .on("mouseover",function(d,i){
                        highlightCountry(d);
                    })
                    .on("mouseout",function(d,i){
                        updateMap();
                    }).style("cursor","pointer");

       var td = tr.selectAll('td')
       .data(function(row, i) {

            var obj = row["values"];
            var temp = [];
          
            temp.push(obj["Country"]);
            temp.push(obj["Emission"]);
            return temp ;
            
       }).enter()
       .append('td');
       td_text = td.html(function(d,i){
            return d;       
       })
    }

    function createLegend(){

        $("#color_legend").empty();
        var svg_legend = d3.select("#color_legend")
                            .append("svg")
                            .attr("width",700)
                            .style("display","block")
                            .style("margin","auto");

        svg_legend.append("g")
          .attr("class", "legendLinear")
          .attr("transform", "translate(20,20)");

        var legendLinear = d3.legend.color()
          .shapeWidth(120)
          .cells(5)
          .orient('horizontal')
          .scale(colorScale)

        svg_legend.select(".legendLinear")
          .call(legendLinear);
    }




    
    
    

    
</script>
    
</body>
</html>