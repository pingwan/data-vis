<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Data Visualisation Final Project</title>

    <link rel="stylesheet" href="/libraries/bootstrap/css/bootstrap.min.css"> 
    <link rel="stylesheet" href="/libraries/bootstrap/css/bootstrap-theme.min.css">
    <script src="/libraries/d3.min.js" charset="utf-8"></script>
    <script src="/libraries/jquery.min.js" charset="utf-8"></script>
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>

    <style>
        .container{
            width: 970px !important;
        }

        #countries_container{
            height:450px;
            overflow: scroll;
        }


        div.tooltip {   
          position: absolute;           
          text-align: center;                           
          padding: 10px;             
          font: 12px sans-serif;        
          background: black;  
          border: 0px;             
          pointer-events: none;  
          color:white;       
}
    </style>

<body>

    <div class="container">

        <div class="row">
            <div class="col-xs-12">
                <div id="year" style=" text-align: center;:center;">
                </div>
            </div>
            <div class="col-xs-12">
                <div id="graph_container" style="background-color:blue; height:50px;"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-9">
                <div id="map_container">
                </div>

            </div>
            <div class="col-xs-3" id="list">
                <div id="countries_container">
                </div>
            </div>
        </div>

            <div class="row">
            <div class="col-xs-12">
                <div id="graph_container" style="background-color:red; height:300px;"></div>
            </div>
        </div>


        </div>

        
    </div>
        
    </div>
    

<script>
    
    var available_countries;
    var emission_data;
    var current_year = 1997;
    var width = 697,
        height = 450;
    var svg;
    var map;
    var projection;
    var interval;
    var header;
    var colorScale;

    var div = d3.select("body").append("div")   
                .attr("class", "tooltip")               
                .style("opacity", 0);
        

    function drawMap(data){
                
        //draw the svg for map
        svg = d3.select("#map_container")
                    .append("svg")
                    //.style("background-color","blue")
                    .attr("width",width)
                    .attr("height",height)
                    .append("g")
                    .classed("map",true)
                    .style("background","blue");

        //initiate projection
        projection  = d3.geo.mercator()
                            .scale(100)
                            .translate([width/2,height/1.4]);
        
        var path = d3.geo.path().projection(projection);
        
        //create the map
        map = svg.selectAll("path")
                    .data(data.features)
                    .enter()
                    .append("path")
                    .attr("d",path)
                    //.style("fill",'rgb(9,157,217)')
                    .style("stroke",'black')
                    .style("stroke-width",0.5);
        
        
        d3.csv("emission_data.csv",function(d){
          
            //console.log(d);
            
            
            emission_data = d;
            
            emission_data =  emission_data.filter(function(d){
                return (available_countries.indexOf(d['Country Code']) !== -1);
            })
        
            /*interval = setInterval(function(){
                if(current_year < 1965){
                    updateMap();
                    current_year++;
                    //console.log("sdf");
                }
            },200)*/

            updateMap();
            
            
        })


    }
    
    function updateMap(){
        
        

        d3.select("#year").html("<h2>" + current_year +"</h2>")
        
        var nested = d3.nest()
                        .key(function(d){
                            return d['Country Code']
                        })
                        .rollup(function(leaves){



                            if(leaves[0][current_year] === ""){
                                return 0;    
                            }else{
                               
                                return{
                                    "Country Name": leaves[0]["Country Name"],
                                    "Emission": parseInt(leaves[0][current_year])
                                }

                            }
                            
                        })
                        .map(emission_data);

         
         createTable();
        
        colorScale = d3.scale.linear()
                        .range(['#fffc57', '#e80000'])
                        .domain(d3.extent(d3.values(nested).map(function(d){return d["Emission"]})));
        
   
        
        svg.selectAll("path")
                    .style("fill",function(d){
                        if(nested[d.id]){

                            return colorScale(nested[d.id]["Emission"]);
                        }else{
                           
                            return "black";
                        }
                    }).on("mouseover",function(d,i){
   
                        div.transition()        
                            .duration(200)      
                            .style("opacity", .9);      
            
                        div.html(function(){
                            return nested[d.id]["Country Name"] + " - " + nested[d.id]["Emission"];
                        })
                        .style("left", (d3.event.pageX) + "px")     
                        .style("top", (d3.event.pageY - 28) + "px");    
            
                    }).on("mouseout",function(d,i){
                           
                        div.transition()        
                            .duration(500)      
                            .style("opacity", 0);   
        
                    })
                
    }
        
//        /*function plot_points(data){
//            //draw circle logic
//            
//            var nested = d3.nest()
//                            .key(function(d){
//                                return d['date'].getUTCFullYear();
//                            })
//                            .rollup(function(leaves){
//                                var total = d3.sum(leaves,function(d){
//                                    return d['attendace'];
//                                })   
//                                
//                                var coords = leaves.map(function(d){
//                                    return projection([+d.long,+d.lat]);
//                                })
//                                
//                                var center_x = d3.mean(coords,function(d){
//                                    return d[0];
//                                });
//                                
//                                var center_y = d3.mean(coords,function(d){
//                                    return d[1];
//                                })
//                                
//                                var teams = d3.set();
//                                
//                                leaves.forEach(function(d){
//                                    teams.add(d['team1']);
//                                    teams.add(d['team2']);
//                                })
//                                
//                                //console.log(teams);
//                                
//                                return {
//                                    'attendance' : total,
//                                    'x' : center_x,
//                                    'y' : center_y,
//                                    'teams' : teams.values()
//                                };
//                            })
//                            .entries(data);
//            
//            //console.log(nested);
//            var temp = nested[0];
//            nested = [];
//            nested.push(temp);
//            
//            //console.log(nested);
//            
//            var teams = temp.values.teams;
//            //console.log(teams);
//            
//            //console.log(nested);
//            
//                /*var attendance_extend = d3.extent(nested,function(d){
//                    return d.values['attendance'];
//                })*
//                
//                /*var radius = d3.scale.sqrt()
//                                .domain(attendance_extend)
//                                .range([0,12]);*/
//            
//                /*svg.append("g")
//                    .classed("bubble",true)
//                    .selectAll("circle")
//                    /*.data(nested.sort(function(a,b){
//                        return b.values['attendance'] -  a.values['attendance'];
//                    }),function(d){
//                        return d['key'];
//                    })*/
//                    .data(nested)
//                    .enter()
//                    .append("circle")
//                    .attr("cx",function(d){
//                        console.log(d);
//                        return d.values.x;
//                    })
//                    .attr("cy",function(d){
//                        return d.values.y
//                    })
//                    .attr("r",function(d){
//                        return 10;
//                    })
//                    .attr("fill","rgb(247,148,32)")
//                    .attr("stroke",'black')
//                    .attr("stroke-width",0.7)
//                    .attr("opacity",0.7);
//            
//                console.log(teams);
//                svg.selectAll("path")
//                    .style("fill",function(d){
//                        //console.log(d);
//                        if(teams.indexOf(d.properties.name) !== -1){
//                            //console.log("hoi");
//                            return "red";
//                        }else{
//                            //console.log("hoi2");
//                            return "white";    
//                        }
//                        
//                    });
//                
//            
//        };
//        
//        function update(year){
//            
//            var filtered = nested.filter(function(d){
//                return new Date(d['key']).getUTCYear() == year;
//            });
//            
//            //var circle = 
//            
//            
//            
//        }
        
        /*var format = d3.time.format("%d-%m-%Y (%H:%M h)");
        
        d3.tsv("world_cup_geo.tsv",function(d){
            d['attendace'] = +d['attendance'];
            d['date'] = format.parse(d['date']);
            return d;
        }, plot_points);*/
        
        
    
    
    
    d3.json("world_countries.json",function(d){
        
        available_countries = d.features.map(function(d){
            return d.id;
        });
        
        console.log(available_countries.slice(0,100));
        console.log(available_countries.slice(100,200));
        
        drawMap(d);

    })


    function highlightCountry(obj){
      
        svg.selectAll("path")
                    .style("fill",function(d){
                    
                        if(d.id != obj.key){
                            return "black"
                        }else{
                            return colorScale(obj.values["Emission"]);
                        }
                    });
        

    }

  

    function createTable(){

        $("#countries_container").empty();

        var nested = d3.nest()
                        .key(function(d){
                            return d['Country Code']
                        })
                        .rollup(function(leaves){
                        
                            return {
                                "Country" : leaves[0]["Country Name"],
                                "Emission" : leaves[0][current_year]
                            }

                        })
                        .entries(emission_data);

        

        var table = d3.select('#countries_container')
                        .append('table')
                        .classed("table",true)
                        .classed("table-striped",true)
                        .classed("table-bordered",true)
                        .style("width","100%");
        

        var heading = ["Country","Emission"];

        table.append('thead')
            .append("tr")
            .selectAll("th")
            .data(heading) 
            .enter()
                .append("th")
                .text(function(d,i){
                    return d;
                })


        var tr = table.append('tbody')
                    .selectAll('tr')
                    .data(nested)
                    .enter()
                    .append('tr')
                    .on("mouseover",function(d,i){
                        highlightCountry(d);
                    })
                    .on("mouseout",function(d,i){
                        updateMap();
                    }).style("cursor","pointer");

       var td = tr.selectAll('td')
       .data(function(row, i) {

            var obj = row["values"];
            var temp = [];
          
            temp.push(obj["Country"]);
            temp.push(obj["Emission"]);
            return temp ;
            
       }).enter()
       .append('td');
       td_text = td.html(function(d,i){
            return d;       
       })
    }




    
    
    

    
</script>
    
</body>
</html>